!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).PropelAuth={})}(this,(function(e){"use strict";function t(e){return fetch(`${e}/api/v1/refresh_token`,{method:"GET",credentials:"include",headers:{"Content-Type":"application/json"}}).then((e=>401===e.status?null:0===e.status?(r(),Promise.reject({status:503,message:"Unable to process authentication response"})):e.ok?function(e){return e.text().then((e=>{try{return t=e,JSON.parse(t,(function(e,t){if("org_id"===e)this.orgId=t;else if("org_name"===e)this.orgName=t;else if("url_safe_org_name"===e)this.urlSafeOrgName=t;else if("user_role"===e)this.userAssignedRole=t;else if("inherited_user_roles_plus_current_role"===e)this.userInheritedRolesPlusCurrentRole=t;else if("user_permissions"===e)this.userPermissions=t;else if("access_token"===e)this.accessToken=t;else if("expires_at_seconds"===e)this.expiresAtSeconds=t;else if("org_id_to_org_member_info"===e)this.orgIdToOrgMemberInfo=t,this.orgHelper=(r=t,{getOrg:e=>r.hasOwnProperty(e)?r[e]:void 0,getOrgIds:()=>Object.keys(r),getOrgs:()=>Object.values(r),getOrgByName(e){for(const t of Object.values(r))if(t.orgName===e||t.urlSafeOrgName===e)return t}}),this.accessHelper=function(e){function t(t,r){const n=e[t];return void 0!==n&&n.userAssignedRole===r}function r(t,r){const n=e[t];return void 0!==n&&n.userInheritedRolesPlusCurrentRole.includes(r)}function n(t,r){const n=e[t];return void 0!==n&&n.userPermissions.includes(r)}function s(t,r){const n=e[t];return void 0!==n&&r.every((e=>n.userPermissions.includes(e)))}return{isRole:t,isAtLeastRole:r,hasPermission:n,hasAllPermissions:s,getAccessHelperWithOrgId:function(e){return{isRole:r=>t(e,r),isAtLeastRole:t=>r(e,t),hasPermission:t=>n(e,t),hasAllPermissions:t=>s(e,t)}}}}(t);else if("user_id"===e)this.userId=t;else if("email_confirmed"===e)this.emailConfirmed=t;else if("first_name"===e)this.firstName=t;else if("last_name"===e)this.lastName=t;else if("picture_url"===e)this.pictureUrl=t;else if("mfa_enabled"===e)this.mfaEnabled=t;else if("has_password"===e)this.hasPassword=t;else if("created_at"===e)this.createdAt=t;else if("last_active_at"===e)this.lastActiveAt=t;else if("legacy_user_id"===e)this.legacyUserId=t;else{if("impersonator_user"!==e)return t;this.impersonatorUserId=t}var r}))}catch(e){return console.error("Unable to process authentication response",e),Promise.reject({status:500,message:"Unable to process authentication response"})}var t}),(e=>(console.error("Unable to process authentication response",e),Promise.reject({status:500,message:"Unable to process authentication response"}))))}(e):Promise.reject({status:e.status,message:e.statusText})))}function r(){console.error("Request to PropelAuth failed due to a CORS error. There are a few likely causes: \n 1. In the Frontend Integration section of your dashboard, make sure your requests are coming either the specified Application URL or localhost with a matching port.\n 2. Make sure your server is hosted on HTTPS in production.")}function n(){return Date.now()/1e3}function s(){return"undefined"!=typeof localStorage}function o(e){if(!s())return null;const t=localStorage.getItem(e);if(!t)return null;const r=parseInt(t,10);return Number.isNaN(r)?null:r}const i="__PROPEL_AUTH_LOGGED_IN_AT",a="__PROPEL_AUTH_LOGGED_OUT_AT";e.createClient=function(e){!function(e){try{const t=new URL(e.authUrl);e.authUrl=t.origin}catch(e){throw console.error("Invalid authUrl",e),new Error("Unable to initialize auth client")}void 0===e.enableBackgroundTokenRefresh&&(e.enableBackgroundTokenRefresh=!0)}(e);const l={initialLoadFinished:!1,authenticationInfo:null,observers:[],lastLoggedInAtMessage:o(i),lastLoggedOutAtMessage:o(a),authUrl:e.authUrl,refreshInterval:null,lastRefresh:null};function u(e){for(let t=0;t<l.observers.length;t++){const r=l.observers[t];r&&r(e)}}function c(e){var t;const r=null===(t=l.authenticationInfo)||void 0===t?void 0:t.accessToken;l.authenticationInfo=e;const o=null==e?void 0:e.accessToken;!function(e,t){return!e&&(t||!l.initialLoadFinished)}(o,r)?function(e,t){return!t&&e}(o,r)&&(u(!0),function(){const e=n();l.lastLoggedInAtMessage=e,s()&&localStorage.setItem(i,String(e))}()):(u(!1),function(){const e=n();l.lastLoggedOutAtMessage=e,s()&&localStorage.setItem(a,String(e))}()),l.lastRefresh=n(),l.initialLoadFinished=!0}async function d(e){try{const e=await t(l.authUrl);return c(e),e}catch(t){if(e)return l.authenticationInfo;throw c(null),t}}const g=e=>{let t="";if(e&&e.postSignupRedirectUrl){const r=window?window.btoa:btoa;t=new URLSearchParams({rt:r(e.postSignupRedirectUrl)}).toString()}return`${l.authUrl}/signup?${t}`},f=e=>{let t="";if(e&&e.postLoginRedirectUrl){const r=window?window.btoa:btoa;t=new URLSearchParams({rt:r(e.postLoginRedirectUrl)}).toString()}return`${l.authUrl}/login?${t}`},h=()=>`${l.authUrl}/account`,p=e=>e?`${l.authUrl}/org?id=${e}`:`${l.authUrl}/org`,m=()=>`${l.authUrl}/create_org`,w=e=>`${l.authUrl}/saml?id=${e}`,v={addLoggedInChangeObserver(e){l.observers.includes(e)?console.error("Observer has been attached already."):e?l.observers.push(e):console.error("Cannot add a null observer")},removeLoggedInChangeObserver(e){const t=l.observers.indexOf(e);-1===t?console.error("Cannot find observer to remove"):l.observers.splice(t,1)},async getAuthenticationInfoOrNull(e){const t=n();if(e)return await d(!1);if(l.authenticationInfo){if(t+240>l.authenticationInfo.expiresAtSeconds){const e=t<l.authenticationInfo.expiresAtSeconds;return await d(e)}return l.authenticationInfo}return await d(!1)},getSignupPageUrl:e=>g(e),getLoginPageUrl:e=>f(e),getAccountPageUrl:()=>h(),getOrgPageUrl:e=>p(e),getCreateOrgPageUrl:()=>m(),getSetupSAMLPageUrl:e=>w(e),redirectToSignupPage(e){window.location.href=g(e)},redirectToLoginPage(e){window.location.href=f(e)},redirectToAccountPage(){window.location.href=h()},redirectToOrgPage(e){window.location.href=p(e)},redirectToCreateOrgPage(){window.location.href=m()},redirectToSetupSAMLPage(e){window.location.href=w(e)},async logout(e){const t=await(n=l.authUrl,fetch(`${n}/api/v1/logout`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}}).then((e=>0===e.status?(r(),Promise.reject({status:503,message:"Unable to process authentication response"})):e.ok?e.json():(console.error("Logout error",e.status,e.statusText),Promise.reject({status:e.status,message:e.statusText})))));var n;c(null),e&&(window.location.href=t.redirect_to)},destroy(){l.observers=[],window.removeEventListener("storage",_),l.refreshInterval&&clearInterval(l.refreshInterval)}},_=async function(){if(!s())return;const e=o(a),t=o(i);e&&(!l.lastLoggedOutAtMessage||e>l.lastLoggedOutAtMessage)&&(l.lastLoggedOutAtMessage=e,l.authenticationInfo&&await d(!0)),t&&(!l.lastLoggedInAtMessage||t>l.lastLoggedInAtMessage)&&(l.lastLoggedInAtMessage=t,l.authenticationInfo||await d(!0))},I=async function(){l.lastRefresh&&n()>l.lastRefresh+240?await d(!0):await v.getAuthenticationInfoOrNull()};return"undefined"!=typeof window&&(window.addEventListener("storage",_),window.addEventListener("online",I),window.addEventListener("focus",I),e.enableBackgroundTokenRefresh&&(v.getAuthenticationInfoOrNull(),l.refreshInterval=window.setInterval(v.getAuthenticationInfoOrNull,6e4))),v}}));
//# sourceMappingURL=javascript.min.js.map
